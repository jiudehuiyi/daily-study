# Web 性能优化 - TCP

TCP 负责在不可靠的传输信道之上提供可靠的抽象层，向应用层隐藏了大多数网络通信的复杂性能，比如丢包重发、按需发送、拥塞控制及避免、数据完整，等等。采用 TCP 数据流可以确保发送的所有字节能够完整地被接收到，而且客户端的顺序也一样。

但是 TCP 设计并未过多顾及时间，由此给浏览器 Web 性能带来了挑战。

所有 TCP 连接一开始都必须经过三次握手。客户端与服务器在交换应用数据之前，必须就起始分组序列号，以及其他一些连接相关的细节达成一致。处于安全考虑，序列号由两端随机生成。

- SYN

  客户端选择一个随机序列号 x，并发送一个 SYN 分组，其中可能还包含 TCP 标志和选项。

- SYN ACK

  服务器给 x 加 1，并选择自己的一个随机序列号 y，追加自己的标志和选项，然后返回响应。

- ACK

  客户端给 x 和 y 加 1，并发送握手期间的最后一个 ACK 分组。

客户端可以在发送 ACK 分组之后立即发送数据，而服务器必须等接收到 ACK 分组之后发送数据。

每个 TCP 连接都要经过三次握手，倘若客户端与服务器距离过长，会造成非常大的性能影响。因而，提升 TCP 性能关键在于想办法重用连接。

为解决这个问题，人们在积极寻找各种方案，其中长链接（Keep-Alive）、负载均衡、TFO(tcp fast open)便是其中的一些解决办法。

### 长链接

Keep-Alive，HTTP 1.1 之后默认开启，指在一个 TCP 连接中可以持续发送多份数据而不会断开连接。

### 负载均衡

基本原理：客户端（如：ClientA）与负载均衡设备之间进行三次握手并发送 HTTP 请求。负载均衡设备收到请求后，会检测服务器是否存在空闲的长链接，如果不存在，服务器将建立一个新连接。当 HTTP 请求响应完成后，客户端与负载均衡设备协商关闭连接，而负载均衡则保持与服务器之间的这个连接。当有其他客户端（如：ClientB）需要发送 HTTP 请求时，负载均衡设备会直接向服务器之间保持的这个空闲连接发送 HTTP 请求，避免来由于新建 TCP 连接造成的延时和服务器资源耗费。

### TFO(tcp fast open)

尽管开启了长链接，可是依然有35%的请求是重新发起一条连接，而握手会造成一定的延迟，TFO 的目标就是为了去除这个延迟，在三次握手期间也能交换数据。

基本原理：

- 客户端发送 SYN 包，包尾加一个 FOC 请求，只有4个字节。
- 服务端收到 FOC 请求，验证后根据来源 ip 地址生成 Cookie（8个字节），将这个 cookie 加载到 SYN + ACK 包的末尾，发送至客户端。
- 客户端缓存获取到的 Cookie 可以给下一次使用。
- 下一次请求开始，客户端发送 SYN 包，这时候后面带上缓存的 Cookie，然后就开始正式发送数据。
- 服务器验证 Cookie 正确，将数据交给上层应用处理得到相应结果，然后在发送 SYN + ACK，不再等待客户端的 ACK 确认，即开始发送相应数据。